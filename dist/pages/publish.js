"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,o){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!o||"object"!=typeof o&&"function"!=typeof o?e:o}function _inherits(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function, not "+typeof o);e.prototype=Object.create(o&&o.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),o&&(Object.setPrototypeOf?Object.setPrototypeOf(e,o):e.__proto__=o)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,o){for(var t=0;t<o.length;t++){var r=o[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(o,t,r){return t&&e(o.prototype,t),r&&e(o,r),o}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_jobform=require("./../components/jobform.js"),_jobform2=_interopRequireDefault(_jobform),_saleform=require("./../components/saleform.js"),_saleform2=_interopRequireDefault(_saleform),_homeform=require("./../components/homeform.js"),_homeform2=_interopRequireDefault(_homeform),_carform=require("./../components/carform.js"),_carform2=_interopRequireDefault(_carform),_findform=require("./../components/findform.js"),_findform2=_interopRequireDefault(_findform),_foodform=require("./../components/foodform.js"),_foodform2=_interopRequireDefault(_foodform),_friendform=require("./../components/friendform.js"),_friendform2=_interopRequireDefault(_friendform),_petform=require("./../components/petform.js"),_petform2=_interopRequireDefault(_petform),_eduform=require("./../components/eduform.js"),_eduform2=_interopRequireDefault(_eduform),_otherform=require("./../components/otherform.js"),_otherform2=_interopRequireDefault(_otherform),_toast=require("./../components/toast.js"),_toast2=_interopRequireDefault(_toast),_avWeappMin=require("./../utils/av-weapp-min.js"),_avWeappMin2=_interopRequireDefault(_avWeappMin),_newslist=require("./../models/newslist.js"),_newslist2=_interopRequireDefault(_newslist),qiniuUploader=require("./../utils/qiniuUploader.js"),genToken=require("./../utils/getUpToken.js").genToken,options={scope:"images",deadline:Date.parse(new Date)+1800,mimeLimit:"image/*"},uploadToken=genToken("-2rQ7jMWwI1PHe_i8c60WOgx7isexE1SI-K5eSPx","uWkWvwDwucTA9ekkbSWMDQPMBt4t8KYtFRkkvrMW",options),Publish=function(e){function o(){var e,t,r,a;_classCallCheck(this,o);for(var n=arguments.length,i=Array(n),f=0;f<n;f++)i[f]=arguments[f];return t=r=_possibleConstructorReturn(this,(e=o.__proto__||Object.getPrototypeOf(o)).call.apply(e,[this].concat(i))),r.data={themeimg:"",gridsArr:null,title:"",subtitle:"",phone:"",publishername:"",type:"job",typename:"职位招聘",formdata:null},r.$repeat={},r.$props={jobform:{"xmlns:v-on":""},saleform:{},homeform:{},carform:{},findform:{},foodform:{},friendform:{},petform:{},eduform:{},otherform:{}},r.$events={jobform:{"v-on:getJobForm":"getForm"},saleform:{"v-on:getSaleForm":"getForm"},homeform:{"v-on:getHomeForm":"getForm"},carform:{"v-on:getCarForm":"getForm"},findform:{"v-on:getFindForm":"getForm"},foodform:{"v-on:getFoodForm":"getForm"},friendform:{"v-on:getFriendForm":"getForm"},petform:{"v-on:getPetForm":"getForm"},eduform:{"v-on:getEduForm":"getForm"},otherform:{"v-on:getOtherForm":"getForm"}},r.components={jobform:_jobform2.default,saleform:_saleform2.default,homeform:_homeform2.default,carform:_carform2.default,findform:_findform2.default,foodform:_foodform2.default,friendform:_friendform2.default,petform:_petform2.default,eduform:_eduform2.default,otherform:_otherform2.default,toast:_toast2.default},r.methods={tap:function(e){this.type=e.type,this.typename=e.name},getForm:function(e){this.formdata=e},titleChange:function(e){this.title=e.detail.value},subTitleChange:function(e){this.subtitle=e.detail.value},phoneChange:function(e){this.phone=e.detail.value},nameChange:function(e){this.publishername=e.detail.value},submit:function(){var e=this.type+"Fetch";this.$broadcast(e);var o=this.checkFormInfo();o.flag?this.ajaxSend():this.$invoke("toast","show",{message:o.info})},priview:function(){var e=this.type+"Fetch";this.$broadcast(e);var o=this.checkFormInfo();o.flag?this.previewSend():this.$invoke("toast","show",{message:o.info})}},a=t,_possibleConstructorReturn(r,a)}return _inherits(o,e),_createClass(o,[{key:"onLoad",value:function(){var e=this;e.themeimg=e.$parent.globalData.themeimg,e.gridsArr=e.$parent.globalData.gridsArr}},{key:"onShow",value:function(){this.$parent.globalData.previewBack&&this.ajaxSend()}},{key:"previewSend",value:function(){var e=this,o=e.$parent.globalData.userNick,t=e.$parent.globalData.userInfo,r={nickname:o.nickName,uid:t.objectId,title:e.title,subtitle:e.subtitle,publishername:e.publishername,phone:e.phone,type:e.type,typename:e.typename,formdata:e.formdata};e.$parent.globalData.previewData=r,wx.navigateTo({url:"preview"})}},{key:"uploadImgs",value:function(e){for(var o=e.formdata.images,t=o.length,r=this,a=[],n=r.$parent.globalData.domain,i=[],f=0;f<t;f++){var s;!function(e){s=new Promise(function(t,r){qiniuUploader.upload(o[e],function(e){a.push(n+e.imageURL),t()},function(e){r()},{region:"ECN",uptoken:uploadToken})}),i.push(s)}(f)}Promise.all(i).then(function(){e.formdata.images=a,r.saveData(e)}).catch(function(e){console.log(e),r.hideLoading(),r.$invoke("toast","show",{message:"图片上传失败，请重试"})})}},{key:"saveData",value:function(e){var o=new _newslist2.default,t=this;o.set("nickname",e.nickname),o.set("uid",e.uid),o.set("title",e.title),o.set("subtitle",e.subtitle),o.set("subtitle",e.subtitle),o.set("phone",e.phone),o.set("publishername",e.publishername),o.set("type",e.type),o.set("typename",e.typename),o.set("formdata",e.formdata),o.save().then(function(e){t.hideLoading(),t.$parent.globalData.previewBack=!1,t.$parent.globalData.refresh=!0,t.$parent.globalData.curUserPublishNum+=1,wx.redirectTo({url:"success"})}).catch(function(e){console.log(e),t.hideLoading(),t.$invoke("toast","show",{message:"发布失败，请重试"})})}},{key:"ajaxSend",value:function(){var e=this,o=e.$parent.globalData.userNick,t=e.$parent.globalData.userInfo,r={nickname:o.nickName,uid:t.objectId,title:e.title,subtitle:e.subtitle,publishername:e.publishername,phone:e.phone,type:e.type,typename:e.typename,formdata:e.formdata};e.showLoading(),e.formdata.images?e.uploadImgs(r):e.saveData(r)}},{key:"showLoading",value:function(){wx.showLoading({title:"提交中..."})}},{key:"hideLoading",value:function(){setTimeout(function(){wx.hideLoading()},100)}},{key:"checkFormInfo",value:function(){var e=null;if(e=this.checkHeadeInfo(),e.flag)switch(this.type){case"job":e=this.checkJobForm();break;case"sale":e=this.checkSaleForm();break;case"home":e=this.checkHomeForm();break;case"car":e=this.checkCarForm();break;case"find":e=this.checkFindForm();break;case"food":e=this.checkFoodForm();break;case"friend":e=this.checkFriendForm();break;case"pet":e=this.checkPetForm();break;case"edu":e=this.checkEduForm();break;case"other":e=this.checkOtherForm()}else this.$invoke("toast","show",{message:e.info});return e}},{key:"checkHeadeInfo",value:function(){var e={flag:!0,info:""},o=/^0{0,1}1[3456789]{1}[0-9]{9}$/gi;return this.title?this.subtitle?this.phone?o.test(this.phone)?e:(e.flag=!1,e.info="手机号格式不正确",e):(e.flag=!1,e.info="手机号不能为空",e):(e.flag=!1,e.info="副标题不能为空",e):(e.flag=!1,e.info="标题不能为空",e)}},{key:"checkJobForm",value:function(){var e={flag:!0,info:""},o=this.formdata;return o.jobname?o.jobprice?o.number?o.address?o.companyName?e:(e.flag=!1,e.info="请填写公司名称",e):(e.flag=!1,e.info="请填写招聘地址",e):(e.flag=!1,e.info="请填写招聘人数",e):(e.flag=!1,e.info="请填写职位月薪",e):(e.flag=!1,e.info="请填写招聘职位",e)}},{key:"checkSaleForm",value:function(){var e={flag:!0,info:""};return this.formdata.address?e:(e.flag=!1,e.info="请填写活动地址",e)}},{key:"checkHomeForm",value:function(){var e={flag:!0,info:""},o=this.formdata;return o.address?o.price?e:(e.flag=!1,e.info="请填写房屋价格",e):(e.flag=!1,e.info="请填写房屋地址",e)}},{key:"checkCarForm",value:function(){var e={flag:!0,info:""},o=this.formdata;return o.carname?o.price?o.mileage?e:(e.flag=!1,e.info="请填写行驶里程",e):(e.flag=!1,e.info="请填写车辆价格",e):(e.flag=!1,e.info="请填写车辆型号/名称",e)}},{key:"checkFindForm",value:function(){var e={flag:!0,info:""};return this.formdata.address?e:(e.flag=!1,e.info="请填写丢失地点",e)}},{key:"checkFoodForm",value:function(){var e={flag:!0,info:""},o=this.formdata;return o.price?o.address?e:(e.flag=!1,e.info="请填写美食地点",e):(e.flag=!1,e.info="请填写人均消费",e)}},{key:"checkFriendForm",value:function(){var e={flag:!0,info:""},o=this.formdata;return o.aboutMeArr.length<2&&!o.aboutMeArr[0]?(e.flag=!1,e.info="请填写关于我信息",e):o.hopeTaArr.length<2&&!o.hopeTaArr[0]?(e.flag=!1,e.info="请填写关于Ta信息",e):e}},{key:"checkPetForm",value:function(){var e={flag:!0,info:""},o=this.formdata;return o.category?o.price?e:(e.flag=!1,e.info="请填写宠物价格",e):(e.flag=!1,e.info="请填写宠物类别",e)}},{key:"checkEduForm",value:function(){var e={flag:!0,info:""},o=this.formdata;return o.price?o.address?e:(e.flag=!1,e.info="请填写培训地点",e):(e.flag=!1,e.info="请填写培训价格",e)}},{key:"checkOtherForm",value:function(){var e={flag:!0,info:""},o=this.formdata;return o.otherInfoArr.length<2&&!o.otherInfoArr[0]?(e.flag=!1,e.info="请填写信息",e):e}}]),o}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Publish,"pages/publish"));