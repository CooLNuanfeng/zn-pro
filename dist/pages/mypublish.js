"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_navbar=require("./../components/navbar.js"),_navbar2=_interopRequireDefault(_navbar),_loading=require("./../components/loading.js"),_loading2=_interopRequireDefault(_loading),_empty=require("./../components/empty.js"),_empty2=_interopRequireDefault(_empty),_footer=require("./../components/footer.js"),_footer2=_interopRequireDefault(_footer),_toast=require("./../components/toast.js"),_toast2=_interopRequireDefault(_toast),_avWeappMin=require("./../utils/av-weapp-min.js"),_avWeappMin2=_interopRequireDefault(_avWeappMin),MyPublish=function(t){function e(){var t,i,s,a;_classCallCheck(this,e);for(var n=arguments.length,l=Array(n),o=0;o<n;o++)l[o]=arguments[o];return i=s=_possibleConstructorReturn(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(l))),s.$repeat={},s.$props={empty:{type:"publish"},"nav-bar":{"xmlns:wx":"","xmlns:v-bind":"","v-bind:navlist.sync":"navlists"},"v-loading":{"v-bind:loading.sync":"loading","v-bind:loadend.sync":"loadend"},footer:{}},s.$events={},s.components={empty:_empty2.default,"nav-bar":_navbar2.default,"v-loading":_loading2.default,footer:_footer2.default,toast:_toast2.default},s.data={uid:"",navlists:[],curNavType:"all",lists:[],initLists:null,themeimg:"",showBar:!1,selectStatus:!1,selectAll:!1,startX:0,startY:0,loading:!1,loadend:!1,page:1,pageSize:20,scrollTop:0,goTopStauts:0,ajaxPedding:!1},s.methods={touchstart:function(t){this.startX=t.changedTouches[0].clientX,this.startY=t.changedTouches[0].clientY},touchmove:function(t,e,i){if(1!=t.status){var s=this,a=s.startX,n=s.startY,l=i.changedTouches[0].clientX,o=i.changedTouches[0].clientY,r=s.angle({X:a,Y:n},{X:l,Y:o});Math.abs(r)>10||(l>a?s.lists[e].status=0:(s.initStatus(0),s.lists[e].status=-1))}},goDetail:function(t){0==t.status&&wx.navigateTo({url:"detail?id="+t.id})},selectItem:function(t){this.lists[t].selected=!this.lists[t].selected,this.checkSelectAll(),this.checkHasSelected()},delItem:function(t,e){this.delFetch([t.id])},doAllSelect:function(t){this.selectAllStatus(!t)},edit:function(){this.initStatus(1),this.showBar=!0},goTop:function(){this.scrollTop=0},scroll:function(t){t.detail.scrollTop>500?this.goTopStauts=1:this.goTopStauts=0,this.scrollTop=t.detail.scrollTop},cancel:function(){this.initStatus(0),this.selectAllStatus(!1),this.selectAll=!1,this.showBar=!1},deleteSelect:function(){if(this.selectStatus){for(var t=[],e=0;e<this.lists.length;e++)this.lists[e].selected&&t.push(this.lists[e].id);this.delFetch(t)}}},s.events={navChange:function(t){t.type?this.curNavType=t.type:this.curNavType="all",this.filterList()}},a=i,_possibleConstructorReturn(s,a)}return _inherits(e,t),_createClass(e,[{key:"onLoad",value:function(){this.themeimg=this.$parent.globalData.themeimg,this.uid=this.$parent.globalData.userInfo.objectId,this.fetch()}},{key:"fetch",value:function(){var t=this,e=new _avWeappMin2.default.Query("NewsList");t.loading=!0,t.showLoading(),e.equalTo("uid",this.uid),e.descending("updatedAt"),e.limit(t.pageSize),e.find().then(function(e){if(console.log(e,"data"),t.loading=!1,t.hideLoading(),0==e.length)return t.loadend=!1,void t.$apply();e.length<t.pageSize&&(t.loadend=!0),t.page++,t.makeParam(e)}).catch(function(e){console.log(e),t.loading=!1,t.$invoke("toast","show",{message:"服务异常，请稍后重试"})})}},{key:"scrollFetch",value:function(){var t=this,e=new _avWeappMin2.default.Query("NewsList");t.loadend||t.loading||(t.loading=!0,e.equalTo("uid",this.uid),e.descending("updatedAt"),e.limit(t.pageSize),e.skip((t.page-1)*t.pageSize),e.find().then(function(e){if(console.log(e,"data"),t.loading=!1,0==e.length)return t.loadend=!1,void t.$apply();e.length<t.pageSize&&(t.loadend=!0),t.page++,t.makeParam(e)}).catch(function(e){console.log(e),t.loading=!1,t.$invoke("toast","show",{message:"服务异常，请稍后重试"})}))}},{key:"delFetch",value:function(t){var e,i,s=[],a=[],n=this,l=[],o=n.$parent.globalData.curUserPublishNum,r=n.$parent.globalData.curUserAttention;if(!n.ajaxPedding){n.ajaxPedding=!0,n.showLoading();for(var u=0;u<t.length;u++){var c,h,p=n.getUserAttentOid(t[u]);c=_avWeappMin2.default.Object.createWithoutData("NewsList",t[u]),l.push(t[u]),s.push(c),p&&(h=_avWeappMin2.default.Object.createWithoutData("UserAttentions",p),a.push(h))}i=_avWeappMin2.default.Object.destroyAll(s).then(function(){for(var t=0;t<l.length;t++)for(var e=0;e<n.initLists.length;e++)n.initLists[e].id==l[t]&&n.initLists.splice(e,1);return n.$parent.globalData.curUserPublishNum=o-l.length,n.$parent.globalData.refresh=!0,_avWeappMin2.default.Object.save()}).catch(function(t){}),a.length?e=_avWeappMin2.default.Object.destroyAll(a).then(function(){return n.$parent.globalData.curUserAttention=n.delFromArr(r,l),n.$parent.globalData.attrefresh=!0,console.log("aa",n.$parent.globalData.curUserAttention),_avWeappMin2.default.Object.save()}).catch(function(t){}):(console.log("bb"),e=Promise.resolve()),Promise.all([i,e]).then(function(){n.filterList(),n.initNavList(),n.initStatus(0),n.selectAllStatus(!1),n.showBar=!1,n.ajaxPedding=!1,n.hideLoading(),n.$apply()}).catch(function(t){console.log(t),n.ajaxPedding=!1,n.hideLoading(),n.$invoke("toast","show",{message:"服务异常，请稍后重试"})})}}},{key:"initStatus",value:function(t){for(var e=0;e<this.lists.length;e++)this.lists[e].status=t}},{key:"selectAllStatus",value:function(t){for(var e=0;e<this.lists.length;e++)this.lists[e].selected=t;this.selectAll=t,this.selectStatus=t}},{key:"checkHasSelected",value:function(){for(var t=!1,e=0;e<this.lists.length;e++)if(this.lists[e].selected){t=!0;break}this.selectStatus=!!t}},{key:"checkSelectAll",value:function(){for(var t=!0,e=0;e<this.lists.length;e++)if(!this.lists[e].selected){t=!1;break}this.selectAll=!!t}},{key:"filterList",value:function(){var t=[],e=this.curNavType;if(this.lists=this.initLists,this.lists.length||(this.loadend=!1),"all"!=e){for(var i=0;i<this.lists.length;i++)this.lists[i].type==e&&t.push(this.lists[i]);this.lists=t}}},{key:"makeParam",value:function(t){for(var e=0;e<t.length;e++){var i=t[e].attributes;i.id=t[e].id,i.status=0,i.selected=!1,i.updatedAt=this.$parent.timeFormate(t[e].updatedAt),this.lists.push(i)}this.initLists=this.lists,this.initNavList(),console.log(this.lists,"list"),this.$apply()}},{key:"initNavList",value:function(){for(var t=[],e=0;e<this.initLists.length;e++){var i={};i.type=this.initLists[e].type,i.name=this.initLists[e].typename,t.push(i)}this.uniqueNavlist(t)}},{key:"uniqueNavlist",value:function(t){this.navlists.length=0;for(var e=0;e<t.length;e++){var i=!1;if(this.navlists.length){for(var s=0;s<this.navlists.length;s++)if(t[e].type==this.navlists[s].type){i=!0;break}i||this.navlists.push(t[e])}else this.navlists.push(t[e])}}},{key:"getUserAttentOid",value:function(t){for(var e,i=this.$parent.globalData.curUserAttentJsonArr,s=0;s<i.length;s++)if(i[s].pid==t){e=i[s].oid;break}return e}},{key:"angle",value:function(t,e){var i=e.X-t.X,s=e.Y-t.Y;return 360*Math.atan(s/i)/(2*Math.PI)}},{key:"showLoading",value:function(){wx.showLoading({title:"请稍等..."})}},{key:"hideLoading",value:function(){setTimeout(function(){wx.hideLoading()},200)}},{key:"delFromArr",value:function(t,e){for(var i=0;i<e.length;i++){var s=t.indexOf(e[i]);-1!==s&&t.splice(s,1)}return t}}]),e}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(MyPublish,"pages/mypublish"));