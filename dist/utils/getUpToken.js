"use strict";

var CryptoJS = require('./crypto-js.js');

function utf16to8(str) {
  var out, i, len, c;
  out = "";
  len = str.length;
  for (i = 0; i < len; i++) {
    c = str.charCodeAt(i);
    if (c >= 0x0001 && c <= 0x007F) {
      out += str.charAt(i);
    } else if (c > 0x07FF) {
      out += String.fromCharCode(0xE0 | c >> 12 & 0x0F);
      out += String.fromCharCode(0x80 | c >> 6 & 0x3F);
      out += String.fromCharCode(0x80 | c >> 0 & 0x3F);
    } else {
      out += String.fromCharCode(0xC0 | c >> 6 & 0x1F);
      out += String.fromCharCode(0x80 | c >> 0 & 0x3F);
    }
  }
  return out;
}

function utf8to16(str) {
  var out, i, len, c;
  var char2, char3;
  out = "";
  len = str.length;
  i = 0;
  while (i < len) {
    c = str.charCodeAt(i++);
    switch (c >> 4) {
      case 0:
      case 1:
      case 2:
      case 3:
      case 4:
      case 5:
      case 6:
      case 7:
        // 0xxxxxxx
        out += str.charAt(i - 1);
        break;
      case 12:
      case 13:
        // 110x xxxx 10xx xxxx
        char2 = str.charCodeAt(i++);
        out += String.fromCharCode((c & 0x1F) << 6 | char2 & 0x3F);
        break;
      case 14:
        // 1110 xxxx 10xx xxxx 10xx xxxx
        char2 = str.charCodeAt(i++);
        char3 = str.charCodeAt(i++);
        out += String.fromCharCode((c & 0x0F) << 12 | (char2 & 0x3F) << 6 | (char3 & 0x3F) << 0);
        break;
    }
  }
  return out;
}

/*
 * Interfaces:
 * b64 = base64encode(data);
 * data = base64decode(b64);
 */
var base64EncodeChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
var base64DecodeChars = new Array(-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 62, -1, -1, -1, 63, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, -1, -1, -1, -1, -1, -1, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, -1, -1, -1, -1, -1, -1, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, -1, -1, -1, -1, -1);

function base64encode(str) {
  var out, i, len;
  var c1, c2, c3;
  len = str.length;
  i = 0;
  out = "";
  while (i < len) {
    c1 = str.charCodeAt(i++) & 0xff;
    if (i == len) {
      out += base64EncodeChars.charAt(c1 >> 2);
      out += base64EncodeChars.charAt((c1 & 0x3) << 4);
      out += "==";
      break;
    }
    c2 = str.charCodeAt(i++);
    if (i == len) {
      out += base64EncodeChars.charAt(c1 >> 2);
      out += base64EncodeChars.charAt((c1 & 0x3) << 4 | (c2 & 0xF0) >> 4);
      out += base64EncodeChars.charAt((c2 & 0xF) << 2);
      out += "=";
      break;
    }
    c3 = str.charCodeAt(i++);
    out += base64EncodeChars.charAt(c1 >> 2);
    out += base64EncodeChars.charAt((c1 & 0x3) << 4 | (c2 & 0xF0) >> 4);
    out += base64EncodeChars.charAt((c2 & 0xF) << 2 | (c3 & 0xC0) >> 6);
    out += base64EncodeChars.charAt(c3 & 0x3F);
  }
  return out;
}

function base64decode(str) {
  var c1, c2, c3, c4;
  var i, len, out;
  len = str.length;
  i = 0;
  out = "";
  while (i < len) {
    /* c1 */
    do {
      c1 = base64DecodeChars[str.charCodeAt(i++) & 0xff];
    } while (i < len && c1 == -1);
    if (c1 == -1) break;
    /* c2 */
    do {
      c2 = base64DecodeChars[str.charCodeAt(i++) & 0xff];
    } while (i < len && c2 == -1);
    if (c2 == -1) break;
    out += String.fromCharCode(c1 << 2 | (c2 & 0x30) >> 4);
    /* c3 */
    do {
      c3 = str.charCodeAt(i++) & 0xff;
      if (c3 == 61) return out;
      c3 = base64DecodeChars[c3];
    } while (i < len && c3 == -1);
    if (c3 == -1) break;
    out += String.fromCharCode((c2 & 0XF) << 4 | (c3 & 0x3C) >> 2);
    /* c4 */
    do {
      c4 = str.charCodeAt(i++) & 0xff;
      if (c4 == 61) return out;
      c4 = base64DecodeChars[c4];
    } while (i < len && c4 == -1);
    if (c4 == -1) break;
    out += String.fromCharCode((c3 & 0x03) << 6 | c4);
  }
  return out;
}
var safe64 = function safe64(base64) {
  base64 = base64.replace(/\+/g, "-");
  base64 = base64.replace(/\//g, "_");
  return base64;
};

function genToken(accessKey, secretKey, putPolicy) {

  var put_policy = JSON.stringify(putPolicy);
  // console.log("put_policy = ", put_policy);


  //SETP 3
  var encoded = base64encode(utf16to8(put_policy));
  // console.log("encoded = ", encoded);

  //SETP 4
  var hash = CryptoJS.HmacSHA1(encoded, secretKey);
  var encoded_signed = hash.toString(CryptoJS.enc.Base64);

  //SETP 5
  var upload_token = accessKey + ":" + safe64(encoded_signed) + ":" + encoded;

  return upload_token;
};

module.exports = {
  genToken: genToken
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdldFVwVG9rZW4uanMiXSwibmFtZXMiOlsiQ3J5cHRvSlMiLCJyZXF1aXJlIiwidXRmMTZ0bzgiLCJzdHIiLCJvdXQiLCJpIiwibGVuIiwiYyIsImxlbmd0aCIsImNoYXJDb2RlQXQiLCJjaGFyQXQiLCJTdHJpbmciLCJmcm9tQ2hhckNvZGUiLCJ1dGY4dG8xNiIsImNoYXIyIiwiY2hhcjMiLCJiYXNlNjRFbmNvZGVDaGFycyIsImJhc2U2NERlY29kZUNoYXJzIiwiQXJyYXkiLCJiYXNlNjRlbmNvZGUiLCJjMSIsImMyIiwiYzMiLCJiYXNlNjRkZWNvZGUiLCJjNCIsInNhZmU2NCIsImJhc2U2NCIsInJlcGxhY2UiLCJnZW5Ub2tlbiIsImFjY2Vzc0tleSIsInNlY3JldEtleSIsInB1dFBvbGljeSIsInB1dF9wb2xpY3kiLCJKU09OIiwic3RyaW5naWZ5IiwiZW5jb2RlZCIsImhhc2giLCJIbWFjU0hBMSIsImVuY29kZWRfc2lnbmVkIiwidG9TdHJpbmciLCJlbmMiLCJCYXNlNjQiLCJ1cGxvYWRfdG9rZW4iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQU1BLFdBQVdDLFFBQVEsZ0JBQVIsQ0FBakI7O0FBRUEsU0FBU0MsUUFBVCxDQUFrQkMsR0FBbEIsRUFBdUI7QUFDckIsTUFBSUMsR0FBSixFQUFTQyxDQUFULEVBQVlDLEdBQVosRUFBaUJDLENBQWpCO0FBQ0FILFFBQU0sRUFBTjtBQUNBRSxRQUFNSCxJQUFJSyxNQUFWO0FBQ0EsT0FBS0gsSUFBSSxDQUFULEVBQVlBLElBQUlDLEdBQWhCLEVBQXFCRCxHQUFyQixFQUEwQjtBQUN4QkUsUUFBSUosSUFBSU0sVUFBSixDQUFlSixDQUFmLENBQUo7QUFDQSxRQUFLRSxLQUFLLE1BQU4sSUFBa0JBLEtBQUssTUFBM0IsRUFBb0M7QUFDbENILGFBQU9ELElBQUlPLE1BQUosQ0FBV0wsQ0FBWCxDQUFQO0FBQ0QsS0FGRCxNQUVPLElBQUlFLElBQUksTUFBUixFQUFnQjtBQUNy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U0FBVEEsTUFBUyxDQUFVQyxNQUFWLEVBQWtCO0FBQzdCQSxXQUFTQSxPQUFPQyxPQUFQLENBQWUsS0FBZixFQUFzQixHQUF0QixDQUFUO0FBQ0FELFdBQVNBLE9BQU9DLE9BQVAsQ0FBZSxLQUFmLEVBQXNCLEdBQXRCLENBQVQ7QUFDQSxTQUFPRCxNQUFQO0FBQ0QsQ0FKRDs7QUFNQSxTQUFTRSxRQUFULENBQWtCQyxTQUFsQixFQUE2QkMsU0FBN0IsRUFBd0NDLFNBQXhDLEVBQW1EOztBQUVqRCxNQUFJQyxhQUFhQyxLQUFLQyxTQUFMLENBQWVILFNBQWYsQ0FBakI7QUFDQTs7O0FBR0E7QUFDQSxNQUFJSSxVQUFVaEIsYUFBYWpCLFNBQVM4QixVQUFULENBQWIsQ0FBZDtBQUNBOztBQUVBO0FBQ0EsTUFBSUksT0FBT3BDLFNBQVNxQyxRQUFULENBQWtCRixPQUFsQixFQUEyQkwsU0FBM0IsQ0FBWDtBQUNBLE1BQUlRLGlCQUFpQkYsS0FBS0csUUFBTCxDQUFjdkMsU0FBU3dDLEdBQVQsQ0FBYUMsTUFBM0IsQ0FBckI7O0FBRUE7QUFDQSxNQUFJQyxlQUFlYixZQUFZLEdBQVosR0FBa0JKLE9BQU9hLGNBQVAsQ0FBbEIsR0FBMkMsR0FBM0MsR0FBaURILE9BQXBFOztBQUVBLFNBQU9PLFlBQVA7QUFDRDs7QUFHREMsT0FBT0MsT0FBUCxHQUFpQjtBQUNmaEIsWUFBVUE7QUFESyxDQUFqQiIsImZpbGUiOiJnZXRVcFRva2VuLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQ3J5cHRvSlMgPSByZXF1aXJlKCcuL2NyeXB0by1qcy5qcycpO1xuXG5mdW5jdGlvbiB1dGYxNnRvOChzdHIpIHtcbiAgdmFyIG91dCwgaSwgbGVuLCBjO1xuICBvdXQgPSBcIlwiO1xuICBsZW4gPSBzdHIubGVuZ3RoO1xuICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcbiAgICBjID0gc3RyLmNoYXJDb2RlQXQoaSk7XG4gICAgaWYgKChjID49IDB4MDAwMSkgJiYgKGMgPD0gMHgwMDdGKSkge1xuICAgICAgb3V0ICs9IHN0ci5jaGFyQXQoaSk7XG4gICAgfSBlbHNlIGlmIChjID4gMHgwN0ZGKSB7XG4gICAgICBvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweEUwIHwgKChjID4+IDEyKSAmIDB4MEYpKTtcbiAgICAgIG91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ODAgfCAoKGMgPj4gNikgJiAweDNGKSk7XG4gICAgICBvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweDgwIHwgKChjID4+IDApICYgMHgzRikpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweEMwIHwgKChjID4+IDYpICYgMHgxRikpO1xuICAgICAgb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8ICgoYyA+PiAwKSAmIDB4M0YpKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG91dDtcbn1cblxuZnVuY3Rpb24gdXRmOHRvMTYoc3RyKSB7XG4gIHZhciBvdXQsIGksIGxlbiwgYztcbiAgdmFyIGNoYXIyLCBjaGFyMztcbiAgb3V0ID0gXCJcIjtcbiAgbGVuID0gc3RyLmxlbmd0aDtcbiAgaSA9IDA7XG4gIHdoaWxlIChpIDwgbGVuKSB7XG4gICAgYyA9IHN0ci5jaGFyQ29kZUF0KGkrKyk7XG4gICAgc3dpdGNoIChjID4+IDQpIHtcbiAgICAgIGNhc2UgMDpcbiAgICAgIGNhc2UgMTpcbiAgICAgIGNhc2UgMjpcbiAgICAgIGNhc2UgMzpcbiAgICAgIGNhc2UgNDpcbiAgICAgIGNhc2UgNTpcbiAgICAgIGNhc2UgNjpcbiAgICAgIGNhc2UgNzpcbiAgICAgICAgLy8gMHh4eHh4eHhcbiAgICAgICAgb3V0ICs9IHN0ci5jaGFyQXQoaSAtIDEpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMTI6XG4gICAgICBjYXNlIDEzOlxuICAgICAgICAvLyAxMTB4IHh4eHggMTB4eCB4eHh4XG4gICAgICAgIGNoYXIyID0gc3RyLmNoYXJDb2RlQXQoaSsrKTtcbiAgICAgICAgb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKChjICYgMHgxRikgPDwgNikgfCAoY2hhcjIgJiAweDNGKSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAxNDpcbiAgICAgICAgLy8gMTExMCB4eHh4IDEweHggeHh4eCAxMHh4IHh4eHhcbiAgICAgICAgY2hhcjIgPSBzdHIuY2hhckNvZGVBdChpKyspO1xuICAgICAgICBjaGFyMyA9IHN0ci5jaGFyQ29kZUF0KGkrKyk7XG4gICAgICAgIG91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYyAmIDB4MEYpIDw8IDEyKSB8ICgoY2hhcjIgJiAweDNGKSA8PCA2KSB8ICgoY2hhcjMgJiAweDNGKSA8PCAwKSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuICByZXR1cm4gb3V0O1xufVxuXG4vKlxuICogSW50ZXJmYWNlczpcbiAqIGI2NCA9IGJhc2U2NGVuY29kZShkYXRhKTtcbiAqIGRhdGEgPSBiYXNlNjRkZWNvZGUoYjY0KTtcbiAqL1xudmFyIGJhc2U2NEVuY29kZUNoYXJzID0gXCJBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OS1fXCI7XG52YXIgYmFzZTY0RGVjb2RlQ2hhcnMgPSBuZXcgQXJyYXkoLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIDYyLCAtMSwgLTEsIC0xLCA2MyxcbiAgNTIsIDUzLCA1NCwgNTUsIDU2LCA1NywgNTgsIDU5LCA2MCwgNjEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAwLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAxMCwgMTEsIDEyLCAxMywgMTQsXG4gIDE1LCAxNiwgMTcsIDE4LCAxOSwgMjAsIDIxLCAyMiwgMjMsIDI0LCAyNSwgLTEsIC0xLCAtMSwgLTEsIC0xLCAtMSwgMjYsIDI3LCAyOCwgMjksIDMwLCAzMSwgMzIsIDMzLCAzNCwgMzUsIDM2LCAzNywgMzgsIDM5LCA0MCxcbiAgNDEsIDQyLCA0MywgNDQsIDQ1LCA0NiwgNDcsIDQ4LCA0OSwgNTAsIDUxLCAtMSwgLTEsIC0xLCAtMSwgLTEpO1xuXG5mdW5jdGlvbiBiYXNlNjRlbmNvZGUoc3RyKSB7XG4gIHZhciBvdXQsIGksIGxlbjtcbiAgdmFyIGMxLCBjMiwgYzM7XG4gIGxlbiA9IHN0ci5sZW5ndGg7XG4gIGkgPSAwO1xuICBvdXQgPSBcIlwiO1xuICB3aGlsZSAoaSA8IGxlbikge1xuICAgIGMxID0gc3RyLmNoYXJDb2RlQXQoaSsrKSAmIDB4ZmY7XG4gICAgaWYgKGkgPT0gbGVuKSB7XG4gICAgICBvdXQgKz0gYmFzZTY0RW5jb2RlQ2hhcnMuY2hhckF0KGMxID4+IDIpO1xuICAgICAgb3V0ICs9IGJhc2U2NEVuY29kZUNoYXJzLmNoYXJBdCgoYzEgJiAweDMpIDw8IDQpO1xuICAgICAgb3V0ICs9IFwiPT1cIjtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjMiA9IHN0ci5jaGFyQ29kZUF0KGkrKyk7XG4gICAgaWYgKGkgPT0gbGVuKSB7XG4gICAgICBvdXQgKz0gYmFzZTY0RW5jb2RlQ2hhcnMuY2hhckF0KGMxID4+IDIpO1xuICAgICAgb3V0ICs9IGJhc2U2NEVuY29kZUNoYXJzLmNoYXJBdCgoKGMxICYgMHgzKSA8PCA0KSB8ICgoYzIgJiAweEYwKSA+PiA0KSk7XG4gICAgICBvdXQgKz0gYmFzZTY0RW5jb2RlQ2hhcnMuY2hhckF0KChjMiAmIDB4RikgPDwgMik7XG4gICAgICBvdXQgKz0gXCI9XCI7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgYzMgPSBzdHIuY2hhckNvZGVBdChpKyspO1xuICAgIG91dCArPSBiYXNlNjRFbmNvZGVDaGFycy5jaGFyQXQoYzEgPj4gMik7XG4gICAgb3V0ICs9IGJhc2U2NEVuY29kZUNoYXJzLmNoYXJBdCgoKGMxICYgMHgzKSA8PCA0KSB8ICgoYzIgJiAweEYwKSA+PiA0KSk7XG4gICAgb3V0ICs9IGJhc2U2NEVuY29kZUNoYXJzLmNoYXJBdCgoKGMyICYgMHhGKSA8PCAyKSB8ICgoYzMgJiAweEMwKSA+PiA2KSk7XG4gICAgb3V0ICs9IGJhc2U2NEVuY29kZUNoYXJzLmNoYXJBdChjMyAmIDB4M0YpO1xuICB9XG4gIHJldHVybiBvdXQ7XG59XG5cbmZ1bmN0aW9uIGJhc2U2NGRlY29kZShzdHIpIHtcbiAgdmFyIGMxLCBjMiwgYzMsIGM0O1xuICB2YXIgaSwgbGVuLCBvdXQ7XG4gIGxlbiA9IHN0ci5sZW5ndGg7XG4gIGkgPSAwO1xuICBvdXQgPSBcIlwiO1xuICB3aGlsZSAoaSA8IGxlbikge1xuICAgIC8qIGMxICovXG4gICAgZG8ge1xuICAgICAgYzEgPSBiYXNlNjREZWNvZGVDaGFyc1tzdHIuY2hhckNvZGVBdChpKyspICYgMHhmZl07XG4gICAgfSB3aGlsZSAoaSA8IGxlbiAmJiBjMSA9PSAtMSk7XG4gICAgaWYgKGMxID09IC0xKSBicmVhaztcbiAgICAvKiBjMiAqL1xuICAgIGRvIHtcbiAgICAgIGMyID0gYmFzZTY0RGVjb2RlQ2hhcnNbc3RyLmNoYXJDb2RlQXQoaSsrKSAmIDB4ZmZdO1xuICAgIH0gd2hpbGUgKGkgPCBsZW4gJiYgYzIgPT0gLTEpO1xuICAgIGlmIChjMiA9PSAtMSkgYnJlYWs7XG4gICAgb3V0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKGMxIDw8IDIpIHwgKChjMiAmIDB4MzApID4+IDQpKTtcbiAgICAvKiBjMyAqL1xuICAgIGRvIHtcbiAgICAgIGMzID0gc3RyLmNoYXJDb2RlQXQoaSsrKSAmIDB4ZmY7XG4gICAgICBpZiAoYzMgPT0gNjEpIHJldHVybiBvdXQ7XG4gICAgICBjMyA9IGJhc2U2NERlY29kZUNoYXJzW2MzXTtcbiAgICB9IHdoaWxlIChpIDwgbGVuICYmIGMzID09IC0xKTtcbiAgICBpZiAoYzMgPT0gLTEpIGJyZWFrO1xuICAgIG91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYzIgJiAwWEYpIDw8IDQpIHwgKChjMyAmIDB4M0MpID4+IDIpKTtcbiAgICAvKiBjNCAqL1xuICAgIGRvIHtcbiAgICAgIGM0ID0gc3RyLmNoYXJDb2RlQXQoaSsrKSAmIDB4ZmY7XG4gICAgICBpZiAoYzQgPT0gNjEpIHJldHVybiBvdXQ7XG4gICAgICBjNCA9IGJhc2U2NERlY29kZUNoYXJzW2M0XTtcbiAgICB9IHdoaWxlIChpIDwgbGVuICYmIGM0ID09IC0xKTtcbiAgICBpZiAoYzQgPT0gLTEpIGJyZWFrO1xuICAgIG91dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKCgoYzMgJiAweDAzKSA8PCA2KSB8IGM0KTtcbiAgfVxuICByZXR1cm4gb3V0O1xufVxudmFyIHNhZmU2NCA9IGZ1bmN0aW9uIChiYXNlNjQpIHtcbiAgYmFzZTY0ID0gYmFzZTY0LnJlcGxhY2UoL1xcKy9nLCBcIi1cIik7XG4gIGJhc2U2NCA9IGJhc2U2NC5yZXBsYWNlKC9cXC8vZywgXCJfXCIpO1xuICByZXR1cm4gYmFzZTY0O1xufTtcblxuZnVuY3Rpb24gZ2VuVG9rZW4oYWNjZXNzS2V5LCBzZWNyZXRLZXksIHB1dFBvbGljeSkge1xuXG4gIHZhciBwdXRfcG9saWN5ID0gSlNPTi5zdHJpbmdpZnkocHV0UG9saWN5KTtcbiAgLy8gY29uc29sZS5sb2coXCJwdXRfcG9saWN5ID0gXCIsIHB1dF9wb2xpY3kpO1xuXG5cbiAgLy9TRVRQIDNcbiAgdmFyIGVuY29kZWQgPSBiYXNlNjRlbmNvZGUodXRmMTZ0bzgocHV0X3BvbGljeSkpO1xuICAvLyBjb25zb2xlLmxvZyhcImVuY29kZWQgPSBcIiwgZW5jb2RlZCk7XG5cbiAgLy9TRVRQIDRcbiAgdmFyIGhhc2ggPSBDcnlwdG9KUy5IbWFjU0hBMShlbmNvZGVkLCBzZWNyZXRLZXkpO1xuICB2YXIgZW5jb2RlZF9zaWduZWQgPSBoYXNoLnRvU3RyaW5nKENyeXB0b0pTLmVuYy5CYXNlNjQpO1xuXG4gIC8vU0VUUCA1XG4gIHZhciB1cGxvYWRfdG9rZW4gPSBhY2Nlc3NLZXkgKyBcIjpcIiArIHNhZmU2NChlbmNvZGVkX3NpZ25lZCkgKyBcIjpcIiArIGVuY29kZWQ7XG5cbiAgcmV0dXJuIHVwbG9hZF90b2tlbjtcbn07XG5cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGdlblRva2VuOiBnZW5Ub2tlblxufVxuIl19